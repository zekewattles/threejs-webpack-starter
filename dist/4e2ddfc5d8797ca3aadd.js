import"./main.css";import*as THREE from"three";import{OrbitControls}from"three/examples/jsm/controls/OrbitControls.js";import*as dat from"dat.gui";const params={enableWind:!0,showBall:!1,togglePins},DAMPING=.03,DRAG=.97,MASS=.1,restDistance=25,xSegs=10,ySegs=10,clothFunction=plane(250,250),cloth=new Cloth(10,10),GRAVITY=981*1.4,gravity=new THREE.Vector3(0,-GRAVITY,0).multiplyScalar(.1),TIMESTEP=.018,TIMESTEP_SQ=.018*.018;let pins=[];const windForce=new THREE.Vector3(0,0,0),ballPosition=new THREE.Vector3(0,-45,0),ballSize=60,tmpForce=new THREE.Vector3;function plane(e,t){return function(i,o,n){const s=(i-.5)*e,r=(o+.5)*t;n.set(s,r,0)}}function Particle(e,t,i,o){this.position=new THREE.Vector3,this.previous=new THREE.Vector3,this.original=new THREE.Vector3,this.a=new THREE.Vector3(0,0,0),this.mass=o,this.invMass=1/o,this.tmp=new THREE.Vector3,this.tmp2=new THREE.Vector3,clothFunction(e,t,this.position),clothFunction(e,t,this.previous),clothFunction(e,t,this.original)}Particle.prototype.addForce=function(e){this.a.add(this.tmp2.copy(e).multiplyScalar(this.invMass))},Particle.prototype.integrate=function(e){const t=this.tmp.subVectors(this.position,this.previous);t.multiplyScalar(.97).add(this.position),t.add(this.a.multiplyScalar(e)),this.tmp=this.previous,this.previous=this.position,this.position=t,this.a.set(0,0,0)};const diff=new THREE.Vector3;function satisfyConstraints(e,t,i){diff.subVectors(t.position,e.position);const o=diff.length();if(0===o)return;const n=diff.multiplyScalar(1-i/o).multiplyScalar(.5);e.position.add(n),t.position.sub(n)}function Cloth(e,t){e=e||10,t=t||10,this.w=e,this.h=t;const i=[],o=[];for(let o=0;o<=t;o++)for(let n=0;n<=e;n++)i.push(new Particle(n/e,o/t,0,.1));for(let s=0;s<t;s++)for(let t=0;t<e;t++)o.push([i[n(t,s)],i[n(t,s+1)],25]),o.push([i[n(t,s)],i[n(t+1,s)],25]);for(let s=e,r=0;r<t;r++)o.push([i[n(s,r)],i[n(s,r+1)],25]);for(let s=t,r=0;r<e;r++)o.push([i[n(r,s)],i[n(r+1,s)],25]);function n(t,i){return t+i*(e+1)}this.particles=i,this.constraints=o,this.index=n}function simulate(e){const t=20*Math.cos(e/7e3)+40;windForce.set(Math.sin(e/2e3),Math.cos(e/3e3),Math.sin(e/1e3)),windForce.normalize(),windForce.multiplyScalar(t);const i=cloth.particles;if(params.enableWind){let e;const t=new THREE.Vector3,o=clothGeometry.index,n=clothGeometry.attributes.normal;for(let s=0,r=o.count;s<r;s+=3)for(let r=0;r<3;r++)e=o.getX(s+r),t.fromBufferAttribute(n,e),tmpForce.copy(t).normalize().multiplyScalar(t.dot(windForce)),i[e].addForce(tmpForce)}for(let e=0,t=i.length;e<t;e++){const t=i[e];t.addForce(gravity),t.integrate(TIMESTEP_SQ)}const o=cloth.constraints,n=o.length;for(let e=0;e<n;e++){const t=o[e];satisfyConstraints(t[0],t[1],t[2])}if(ballPosition.z=90*-Math.sin(e/600),ballPosition.x=70*Math.cos(e/400),params.showBall){sphere.visible=!0;for(let e=0,t=i.length;e<t;e++){const t=i[e].position;diff.subVectors(t,ballPosition),diff.length()<60&&(diff.normalize().multiplyScalar(60),t.copy(ballPosition).add(diff))}}else sphere.visible=!1;for(let e=0,t=i.length;e<t;e++){const t=i[e].position;t.y<-250&&(t.y=-250)}for(let e=0,t=pins.length;e<t;e++){const t=i[pins[e]];t.position.copy(t.original),t.previous.copy(t.original)}}const pinsFormation=[];function togglePins(){pins=pinsFormation[~~(Math.random()*pinsFormation.length)]}let container,stats,camera,scene,renderer,clothGeometry,sphere,object;function init(){container=document.getElementById("container"),scene=new THREE.Scene,scene.background=new THREE.Color(15817252),camera=new THREE.PerspectiveCamera(10,window.innerWidth/window.innerHeight,1,1e4),camera.position.set(1e3,50,1500),scene.add(new THREE.AmbientLight(6710886));const e=new THREE.DirectionalLight(14674943,1);e.position.set(50,200,100),e.position.multiplyScalar(1.3),e.castShadow=!0,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024;const t=300;e.shadow.camera.left=-t,e.shadow.camera.right=t,e.shadow.camera.top=t,e.shadow.camera.bottom=-t,e.shadow.camera.far=1e3,scene.add(e);const i=(new THREE.TextureLoader).load("/images/apluse_flip_color.png");i.anisotropy=16;const o=new THREE.MeshLambertMaterial({map:i,side:THREE.DoubleSide,alphaTest:.5});clothGeometry=new THREE.ParametricBufferGeometry(clothFunction,cloth.w,cloth.h),object=new THREE.Mesh(clothGeometry,o),object.position.set(0,0,0),object.castShadow=!0,scene.add(object),object.customDepthMaterial=new THREE.MeshDepthMaterial({depthPacking:THREE.RGBADepthPacking,map:i,alphaTest:.5});const n=new THREE.SphereGeometry(60,32,16),s=new THREE.MeshLambertMaterial;sphere=new THREE.Mesh(n,s),sphere.castShadow=!0,sphere.receiveShadow=!0,sphere.visible=!1,scene.add(sphere),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),container.appendChild(renderer.domElement),renderer.outputEncoding=THREE.sRGBEncoding,renderer.shadowMap.enabled=!0;const r=new OrbitControls(camera,renderer.domElement);if(r.maxPolarAngle=.5*Math.PI,r.minDistance=1e3,r.maxDistance=5e3,r.enabled=!1,window.addEventListener("resize",onWindowResize),"undefined"!=typeof TESTING)for(let e=0;e<50;e++)simulate(500-10*e)}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function animate(e){requestAnimationFrame(animate),simulate(e),render(),stats.update()}function render(){const e=cloth.particles;for(let t=0,i=e.length;t<i;t++){const i=e[t].position;clothGeometry.attributes.position.setXYZ(t,i.x,i.y,i.z)}clothGeometry.attributes.position.needsUpdate=!0,clothGeometry.computeVertexNormals(),sphere.position.copy(ballPosition),renderer.render(scene,camera)}pins=[6],pinsFormation.push(pins),pins=[0,1,2,3,4,5,6,7,8,9,10],pinsFormation.push(pins),pins=[0],pinsFormation.push(pins),pins=[],pinsFormation.push(pins),pins=[0,cloth.w],pinsFormation.push(pins),pins=pinsFormation[1],init(),animate(0);